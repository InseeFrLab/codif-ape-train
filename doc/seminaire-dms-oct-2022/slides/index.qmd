---
title: Codification automatique de l’APE dans le cadre du projet Sirene 4 
subtitle: |
  **[Séminaire DMS]{.orange}**
author: |
  Thomas Faria,
  Tom Seimandi
date: 7 octobre 2022
slide-number: true
# uncomment for French presentations:
# lang: fr-FR
# for blind readers:
slide-tone: false
chalkboard: # press the B key to toggle chalkboard
  theme: whiteboard
# uncomment to use the multiplex mode:
# multiplex: true
format:
  onyxia-revealjs:
    output-file: index.html
controls: true
css: custom.css
from: markdown+emoji
---

```{r}
## Initialisation
library(readr)
library(ggplot2)
library(dplyr)
source("../../../graphs/theme_custom.R")

Accuracy_lvl <- read_csv("../../../graphs/data_graphs/Accuracy_lvl.csv")
GU_TEST_distrib <- read_csv("../../../graphs/data_graphs/GU_TEST_distrib.csv")
TOPK_Accuracy <- read_csv("../../../graphs/data_graphs/TOPK_Accuracy.csv")
Accuracy_reprise <- read_csv("../../../graphs/data_graphs/Accuracy_reprise.csv")
F1_distrib_by_cat <- read_csv("../../../graphs/data_graphs/F1_distrib_by_cat.csv")
IC_distrib <- read_csv("../../../graphs/data_graphs/IC_distrib.csv")
IC_thresholds <- read_csv("../../../graphs/data_graphs/IC_thresholds.csv")

```

# Introduction

## Contexte 


- [**Plusieurs changements majeurs**]{.blue2} : 
  - [**Interne**]{.green2} : Refonte du répertoire [**Sirene 4**]{.orange}.
  - [**Externe**]{.green2} : Mise en place d'un [**guichet unique**]{.orange}.

- [**Constat**]{.blue2} : [**Sicore**]{.orange} n'est plus l'outil adapté ➨ 30% de codification automatique.

- [**Conséquence**]{.blue2} : moment idéal pour proposer une nouvelle méthodologie de codification automatique de l'APE.

## Données

- [$\approx$ **10 millions**]{.orange} de liasses d'entreprises issues de Sirene 3 couvrant la période 2014-2022.
- [**Données labellisées**]{.orange} par Sicore ou par un gestionnaire.
- Une observation consiste en : 
  - un [**descriptif textuel**]{.red2} de l'activité
  - la [**nature de l’activité**]{.blue2} -- [NAT]{.green2} (23 modalités)
  - le [**type de la liasse**]{.blue2} -- [TYP]{.green2} (15 modalités)
  - le [**type d’évènement**]{.blue2} -- [EVT]{.green2} (24 modalités)
  - la [**surface ($m^2$)**]{.blue2}-- [SUR]{.green2} (4 modalités)

## La nomenclature hiérarchique de l'APE

| Niveau | Code | Libellé | Taille |
|-------|------|----------------------|-|
| Section     | H     |Transports et entreposage|21|
| Division    | 52    |Entreposage et services auxiliaires des transports|88|
| Groupe      | 522   |Services auxiliaires des transports|272|
| Classe      | 5224  |Manutention|615|
| **Sous-classe** | [**5224A**]{.red2} |**Manutention portuaire**|[**732**]{.orange}|

# Méthodologie

## Vectorisation des libellés

- [**Plongements lexicaux**]{.orange} : méthode de [**vectorisation**]{.blue2}.
- Plongements [**pré-entraînés**]{.orange} disponibles en open-source.
- On apprend [**nos propres**]{.orange} plongements de [**mots**]{.blue2}.
- Mais aussi des plongements pour :
  - Les [**n-grams de mots**]{.blue2}.
  - Les [**n-grams de caractères**]{.blue2}.

Diagramme

## Classifieur linéaire

- [**2 méthodes**]{.orange} pour la classification : 
  - [**Softmax**]{.blue2} : un [**unique**]{.green2} classifieur multiclasse.
  - [**One-vs-all**]{.blue2} : de [**multiples**]{.green2} classifieurs binaires.
- [**Optimisation**]{.orange} : algorithme de type [**descente de gradient stochastique**]{.blue2}.
- [**Fonction de perte**]{.orange} : [**entropie croisée**]{.blue2}.

## Classification à partir de plongements lexicaux

![](img/fastText_desc_ape.png){height="400" fig-align="center"}

## Implémentation, entraînement

::: {layout-ncol=2}
![](img/fasttext.png){height="100"}

![](img/mlflow.png){height="100"}
:::

- [**fastText**]{.blue2} : librairie rapide (`C++`) et facilement utilisable.
- Optimisation des paramètres d'entraînement et hyperparamètres avec [**mlflow**]{.blue2}.

## Prise en compte des variables catégorielles

- [**Concaténation**]{.orange} du libellé avec les noms et valeurs des variables annexes :

Libellé | NAT | TYP | EVT | SUR | 
--------|-----|-----|-----|-----|
Cours de musique | NaN | X | 01P |NaN

<center>
&#129155;
</center>

"Cours de musique [NAT]{.green2}\_[NaN]{.blue2} [TYP]{.green2}\_[X]{.blue2} [EVT]{.green2}\_[01P]{.blue2} [SUR]{.green2}\_[NaN]{.blue2}"

- [**Méthode imparfaite**]{.orange} : 3-grams "AT_" ou "T_0" utilisés.

## Prétraitements effectués

-  [**Nettoyage**]{.orange} indispensable pour l'analyse textuelle.
- [**Contrainte**]{.orange} : [**simple**]{.blue2}, [**léger**]{.blue2} et facilement [**reproductible**]{.blue2} en Java.


Transformation | Libellé |
--|-------------|
Entrée | 3 D : La Deratisation - La Desinsectisation - La Desinfection |
Passage en minuscule | 3 d : la deratisation - la desinsectisation - la desinfection |
Suppression des ponctuations | 3 d la deratisation la desinsectisation la desinfection |

## Prétraitements effectués

Transformation | Libellé |
--|-------------|
Entrée | 3 D : La Deratisation - La Desinsectisation - La Desinfection |
... | ... |
Suppression des chiffres | d la deratisation la desinsectisation la desinfection |
Suppression des mots à une lettre | la deratisation la desinsectisation la desinfection |
Suppression des *stopwords* | deratisation desinsectisation desinfection |

## Prétraitements effectués

Transformation | Libellé |
--|-------------|
Entrée | 3 D : La Deratisation - La Desinsectisation - La Desinfection |
... | ... |
Suppression des NaN | deratisation desinsectisation desinfection |
Racinisation des mots | deratis desinsectis desinfect |



## Évaluation de la performance

- Évaluation sur [**2 jeux de données**]{.orange} :
  - un jeu de [**test**]{.blue2}, 20\% des données soit [$\approx$ **2.5 millions**]{.green2} observations
  - un jeu issue du [**guichet unique**]{.blue2} [$\approx$ **15 000**]{.green2} observations


```{r fig.width=13,fig.height=4.5, fig.align="center"}

plot_GU_TEST_distrib <- function(data){
  plot <- ggplot(data, aes(x=ground_truth_1, y=Share, fill=Type))+
    ggtitle('Distribution des classes au niveau 1 en fonction des jeux de données')+
    geom_bar(stat = "identity", position = position_dodge())+
    geom_text(aes(label=round(Share*100,1)), position=position_dodge(width=0.9), vjust=-0.25, size=4)+
    scale_y_continuous(labels = scales::percent)+
    scale_fill_manual(values=c(Palette_col), labels=c("Données guichet unique", "Données test"))+
    theme_custom()+
    theme(
      plot.title=element_text(size=26, margin=margin(b=0.7, unit='cm')),
      legend.text = element_text(size = 18),
      axis.text.y = element_text(size = 18),
      axis.text.x = element_text(size = 18),
    )
  
  return(plot)
  
}

plot_GU_TEST_distrib(GU_TEST_distrib)


```



## Évaluation de la performance

- [**4 métriques**]{.orange} pour l'analyse de la performance : 
  - Le [**taux de précision**]{.blue2} : taux global de liasses bien prédites (*accuracy*).
  - Le [**rappel**]{.blue2} : taux de bonnes prédictions de la classe K parmi les vraies valeurs K.
  - La [**précision**]{.blue2} : taux de bonnes prédictions de la classe K parmi les prédictions K.
  - Le [**score F1**]{.blue2} : Moyenne harmonique du rappel et de la précision.


# Principaux résultats

## Une bonne performance globale


```{r fig.width=13,fig.height=5, fig.align="center"}
Accuracy_lvl <- Accuracy_lvl %>%
    mutate(Level = factor(Level, levels = paste("Niveau", paste(seq(5,1,-1))))
    )

plot_Accuracy_lvl <- function(data){
  plot<- ggplot(data , aes(x=Level, y=Accuracy, fill=Type))+
    ggtitle("Taux de précision pour chaque niveau de la nomenclature du code APE")+
    geom_bar(stat = "identity", position = position_dodge())+
    geom_text(aes(label=round(Accuracy,2)), position=position_dodge(width=0.9), vjust=-0.25, size = 6)+
    scale_fill_manual(values=c(Palette_col), labels=c("Données guichet unique", "Données test"))+
    guides(fill=guide_legend(nrow=1, byrow=TRUE))+
    expand_limits(y = 1.)+
    theme_custom()+
    theme(
      text = element_text(size = 16),
      plot.title=element_text(size=26, margin=margin(b=0.7, unit='cm')),
      legend.text = element_text(size = 18),
      axis.text.y = element_text(size = 18),
      axis.text.x = element_text(size = 18),
    )
  return(plot)
}

plot_Accuracy_lvl(Accuracy_lvl)

```


- Près de [**80%**]{.orange} des libellés issus du guichet unique sont correctement codifiés.
- Erreurs de prédiction [**proches**]{.orange} dans la nomenclature.

## Une aide à la reprise manuelle


```{r fig.width=13,fig.height=5, fig.align="center"}
plot_TOPK_Accuracy <- function(data){
  plot<- ggplot(data , aes(x=Type, y=Accuracy, fill=Topk))+
    ggtitle("Top-K Accuracy pour chaque jeu de données")+
    geom_bar(stat = "identity", position = position_dodge())+
    geom_text(aes(label=round(Accuracy,2)), position=position_dodge(width=0.9), vjust=-0.25, size = 6)+
    scale_fill_manual(values=c(Palette_col))+
    expand_limits(y = 1.)+
    guides(fill=guide_legend(nrow=1, byrow=TRUE))+
    theme_custom()+
    theme(
      text = element_text(size = 16),
      plot.title=element_text(size=26, margin=margin(b=0.7, unit='cm')),
      legend.text = element_text(size = 18),
      axis.text.y = element_text(size = 18),
      axis.text.x = element_text(size = 18),
    )
  return(plot)
}

plot_TOPK_Accuracy(TOPK_Accuracy)


```

- Connaissance des probabilités pour chaque classe.
- Dans [**94%**]{.orange} des cas, la bonne classification se trouve dans les 5 prédictions les plus probables. 

## Une performance hétérogène en fonction des classes

```{r  fig.width=13,fig.height=7, fig.align="center"}

F1_distrib_by_cat <- F1_distrib_by_cat %>%
      mutate(
           Group = factor(Group, levels = c("Catégories représentant 50% des données",
                                            "Catégories représentant 25% des données",
                                            "Catégories représentant 20% des données",
                                            "Catégories représentant 5% des données"
                                            
           ))
           )

plot_F1_distrib_by_cat <- function(data){
  ggplot(data) + 
    ggtitle("Distribution du F1-score en fonction de la fréquence des classes")+
    geom_histogram(aes(x=value, fill=Group),binwidth=.05, position="identity") +
    facet_wrap(. ~ Group,ncol = 1, strip.position="left") +
    theme_custom()+
    xlim(c(0,1))+
    scale_fill_manual(values = Palette_col)+
    theme(strip.placement = "outside",
          strip.text.y = element_blank(),
          text = element_text(size = 16),
          plot.title=element_text(size=26, margin=margin(b=0.7, unit='cm')),
          legend.text = element_text(size = 22),
          axis.text.y = element_text(size = 18),
          axis.text.x = element_text(size = 18),
          panel.spacing = unit(1, "lines")
    )+
    guides(fill=guide_legend(nrow=2, byrow=TRUE))
  
}



plot_F1_distrib_by_cat(F1_distrib_by_cat)


```

- [**Performance mitigée**]{.orange} sur plusieurs classes peu fréquentes.

# Indice de confiance et reprise manuelle

## Construction d'un indice de confiance


```{r fig.width=13, fig.height=5, fig.align="center"}
plot_IC_distrib <- function(data, thresholds, ypos){
  plot <- ggplot(data)+
    ggtitle("Distribution de l’indice de confiance en \nfonction du résultat de la prédiction")+
    geom_histogram(aes(x=Score, fill=Results, y=..density..),binwidth=.01, alpha=.5, position="identity") +
    scale_fill_manual(values=c(Palette_col),labels=c("Mauvaises prédictions", "Bonnes prédictions"))+
    geom_vline(xintercept = thresholds$x, color = rgb(83, 83, 83, maxColorValue = 255))+
    theme_custom()+
    theme(
      plot.title=element_text(size=26, margin=margin(b=0.7, unit='cm')),
      legend.text = element_text(size = 24),
      axis.text.y = element_text(size = 24),
      axis.text.x = element_text(size = 24),
    )+
    annotate("text", x = thresholds$x+0.03, y = ypos, label = c("5%", "10%", "15%", "20%", "25%"), size = 7)
  
  return(plot)
  
}

plot_IC_distrib(IC_distrib, IC_thresholds, 51)


```

- [**Objectif**]{.orange} : [**discriminer**]{.blue2} les *mauvaises* des *bonnes* prédictions.
- [**Indice de confiance retenu**]{.orange} : différence entre les deux probabilités les plus élevées.


## Efficacité de la reprise manuelle


```{r fig.width=13,fig.height=5, fig.align="center"}
Accuracy_reprise <- Accuracy_reprise %>%
      mutate(
           Rate = factor(Rate, levels = paste0(paste(seq(0,25,5)), "%"))
      )
plot_Accuracy_reprise <- function(data){
  plot<- ggplot(data , aes(x=Type, y=Accuracy, fill=Rate))+
    ggtitle("Accuracy en fonction du taux de reprise manuelle effectuée")+
    geom_bar(stat = "identity", position = position_dodge())+
    geom_text(aes(label=round(Accuracy,2)), position=position_dodge(width=0.9), vjust=-0.25, size= 5)+
    scale_fill_manual(values=c(Palette_col))+
    guides(fill=guide_legend(nrow=1, byrow=TRUE))+
    theme_custom()+
    theme(
      text = element_text(size = 16),
      plot.title=element_text(size=26, margin=margin(b=0.7, unit='cm')),
      legend.text = element_text(size = 18),
      axis.text.y = element_text(size = 18),
      axis.text.x = element_text(size = 18),
    )
  return(plot)
}


plot_Accuracy_reprise(Accuracy_reprise)


```

- Optimisation de la reprise manuelle ➨ [**gain de performance**]{.orange}.

# Enjeux liés à la mise en production

## Organisation prévue

- Intégration dans [**Sirene 4**]{.orange} pour coder le guichet unique.
- Module de codification : API construite sur `JFastText`.
- Définition du contenu des [**logs**]{.orange} pour contrôle futur.
- [**Double rôle**]{.orange} du SSP Lab à moyen terme :
  - [**Livraison**]{.blue2} des modèles entraînés.
  - [**Contrôle**]{.blue2} qualité.


:::{.callout-important}
## À clarifier

1) Identification des liasses non-codables.
2) Utilisation du module comme aide à la reprise manuelle.
:::

## Organisation à terme ?

![](img/orga_ape.png)

## Problématiques pour la codification en production

- [**Gestion des versions**]{.orange} des modèles en production ?
- [**Contrôle du modèle**]{.orange} en production : quoi et à quelle fréquence ?
- [**Contrôle des entrées**]{.orange} à coder ?
- [**Réentraînement**]{.orange} d'un modèle : comment et à quelle fréquence ?
- Utilisation et maintenance des différents modules ?
- Gestion des [**changements de nomenclature**]{.orange} ?
